<html>
<head>
    <style></style>
</head>
<body class="body">

<canvas id="canvas" style="border:solid black 1px;"></canvas>
<br>
<div style="display: flex">
    <div style="width: 100px" align="center">roomId:</div>
    <div id="roomId"></div>
    <div style="width: 100px" align="center">playerIdx:</div>
    <div id="playerIdx"></div>
</div>
<br>
log:
<pre id="log" style="border: 1px solid #ccc;"></pre>
</body>
<script>
    const canvasW = 600, canvasH = 600;
    const canvas = document.getElementById("canvas");
    canvas.width = canvasW, canvas.height = canvasH;
    const ctx = canvas.getContext("2d");

    let roomIdDiv = document.getElementById('roomId');
    let playerIdxDiv = document.getElementById('playerIdx');

    // canvas.addEventListener("touchstart", (e) => touchHandler(e), false);
    // canvas.addEventListener("touchend", (e) => touchHandler(e), false);
    // canvas.addEventListener("mousedown", (e) => touchHandler(e), false);
    // canvas.addEventListener("mouseup", (e) => touchHandler(e), false);
    canvas.addEventListener("click", (e) => touchHandler(e), false);

    function log(msg) {
        const p = document.getElementById('log');
        p.innerHTML = msg + "\n" + p.innerHTML;

    }

    function touchHandler(e) {
        // console.log(e + " type:" + e.type);
        // log(e + " type:" + e.type);
        // drawPlayer(-40);

        send("1");
    }

    ctx.fillStyle = "rgba(0,0,0,1)";

    let playerIdx = 0, frameIdx = 0, roomId = 0;
    let playerIdxes = [];
    let playerPoses = [];
    const playerW = 20, playerH = 20, playerSpeed = 2, clickOffset = -40;
    let playerX = 100, playerY = 300, playerXOffset = 100;

    ctx.beginPath();
    ctx.rect(playerX, playerY, playerW, playerH);
    ctx.fill();

    let t0 = new Date().getTime();
    let t1 = t0;
    let frames = 0;

    // draw();

    function drawPlayer(deltaY) {
        ctx.clearRect(playerX, playerY, playerW, playerH);
        playerY += deltaY;
        ctx.beginPath();
        ctx.rect(playerX, playerY, playerW, playerH);
        ctx.fill();
    }

    function draw() {
        ++frames;
        if ((frames & 1) == 0) {
            window.requestAnimationFrame(draw);
            return;
        }
        t1 = new Date().getTime();
        if (t1 - t0 >= 1000) {
            console.log(frames);
            t0 = t1;
        }
        if (playerY >= canvasH - playerH) {
            return;
        }

        drawPlayer(playerSpeed);
        window.requestAnimationFrame(draw);
    }

    function handleMsg(msg) {
        let type = msg.charAt(0);
        if (type == 'r') { // room data
            let msgArr = msg.split(',');
            roomId = msgArr[1];
            playerIdx = msgArr[msgArr.length - 1];
            roomIdDiv.innerText = roomId;
            playerIdxDiv.innerText = playerIdx;
            playerIdxes = [];
            playerPoses = [];
            for (let i = 2; i < msgArr.length - 1; ++i) {
                playerIdxes.push(msgArr[i]);
                playerPoses.push(playerX + playerXOffset * (i - 2));
                playerPoses.push(playerY);
            }
            console.log(playerIdxes);
        } else if (type == 'f') { // frame data
            // TODO 多player更新显示
            // TODO 将消息放入队列，按一定频率更新显示（平滑网络延迟）
            if (playerY >= canvasH - playerH) {
                return;
            }
            let msgArr = msg.split(';');
            frameIdx = msgArr[0].substring(1);
            for (let i = 1, len = msgArr.length - 1; i < len; ++i) {
                let opArr = msgArr[i].split(',');
                let pIdx = opArr[0];
                let op = opArr[1];
                if (pIdx == playerIdx) {
                    if (op == '1')
                        drawPlayer(clickOffset);
                    else
                        drawPlayer(playerSpeed);
                }
            }
        }
    }

    let websocket = null;
    connectWebSocket();

    function connectWebSocket() { //建立WebSocket连接
        console.log("start ws...");
        websocket = new WebSocket("ws://127.0.0.1:80/wsdemo"); //建立webSocket连接

        websocket.onopen = function () { //打开webSokcet连接时，回调该函数
            console.log("on open");
            send("0");
        }

        websocket.onclose = function (e) { //关闭webSocket连接时，回调该函数
            console.log("on close:", e.code, e.reason, e.data);
        }

        websocket.onerror = function (e) { //错误处理
            console.log("on error:", e.code, e.reason, e.data);
        }

        websocket.onmessage = function (msg) { //接收信息
            handleMsg(msg.data);
        }
    }

    //发送消息
    function send(msg) {
        websocket.send(msg);
    }

    //关闭连接
    function closeWebSocket() {
        if (websocket != null) {
            websocket.close();
        }
    }

</script>
</html>